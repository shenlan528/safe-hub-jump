<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>跳转提示页</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 2em;
      margin: 0;
      background: #f2f2f2;
    }
    #safe-content, #warning {
      display: none;
    }
    .btn {
      display: block;
      margin: 1em auto;
      padding: 1em;
      font-size: 18px;
      background: linear-gradient(90deg, #ff7a18, #af002d 70%);
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      width: 90%;
      max-width: 320px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    #tip-img {
      max-width: 200px;
      margin-top: 1em;
    }
  </style>
</head>
<body>

  <!-- 默认展示的提示图 -->
  <div id="warning">
    <img id="tip-img" src="/tip.png" alt="请用浏览器打开" />
    <h3>请点击右上角「···」，选择“在浏览器中打开”</h3>
  </div>

  <!-- 系统浏览器才展示跳转按钮 -->
  <div id="safe-content">
    <button class="btn" onclick="goLive(1)">看直播通道 1</button>
    <button class="btn" onclick="goLive(2)">看直播通道 2</button>
    <button class="btn" onclick="goLive(3)">看直播通道 3</button>
  </div>

  <script>
    const ua = navigator.userAgent.toLowerCase();

    const embeddedBrowsers = [
      'micromessenger', 'toutiao', 'tiktok', 'douyin',
      'musical_ly', 'trill', 'fbav', 'instagram',
      'line', 'bytedancewebview'
    ];

    const isSafeBrowser = () => {
      return !embeddedBrowsers.some(keyword => ua.includes(keyword));
    };

    if (isSafeBrowser()) {
      document.getElementById("safe-content").style.display = "block";
    } else {
      document.getElementById("warning").style.display = "block";
    }

    async function goLive(n) {
      const id = `a${n}`;
      const ts = Math.floor(Date.now() / 1000);
      const key = 'LoveTheTk@@EveryDay';

      const sign = await sha256(ts + key);
      const res = await fetch(`/api/jump?id=${id}&ts=${ts}&sign=${sign}`);
      const data = await res.json();

      if (data.t) {
        const decoded = atob(data.t);
        location.href = decoded;
      } else {
        alert("跳转失败，请稍后再试");
      }
    }

    async function sha256(input) {
      const buffer = new TextEncoder().encode(input);
      const hash = await crypto.subtle.digest('SHA-256', buffer);
      return Array.from(new Uint8Array(hash))
        .map(b => b.toString(16).padStart(2, '0')).join('');
    }

    fetch('/api/log-ua', {
      method: 'POST',
      body: JSON.stringify({ ua: navigator.userAgent })
    });
  </script>
</body>
</html>
